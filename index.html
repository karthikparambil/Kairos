<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kairos Clock</title>
    <style>
        :root {
            /* Default Theme: Nebula */
            --bg-dark: #0f0f13;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --primary: #6366f1; /* Indigo */
            --secondary: #8b5cf6; /* Purple */
            --accent-rose: #f43f5e;
            --text-main: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.5);
            --font-stack: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Theme: Cyberpunk */
        [data-theme="cyberpunk"] {
            --bg-dark: #050505;
            --glass-bg: rgba(20, 20, 20, 0.6);
            --glass-border: rgba(252, 238, 10, 0.3);
            --primary: #fcee0a; /* Neon Yellow */
            --secondary: #00ff9f; /* Neon Green */
            --accent-rose: #ff00ff; /* Neon Magenta */
            --text-main: #e0e0e0;
            --text-muted: rgba(255, 255, 255, 0.6);
        }

        /* Theme: Forest */
        [data-theme="forest"] {
            --bg-dark: #022c22;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(52, 211, 153, 0.2);
            --primary: #10b981; /* Emerald */
            --secondary: #34d399; /* Light Green */
            --accent-rose: #fbbf24; /* Amber */
        }

        /* Theme: Sunset */
        [data-theme="sunset"] {
            --bg-dark: #2a0a0a;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(249, 115, 22, 0.2);
            --primary: #f97316; /* Orange */
            --secondary: #db2777; /* Pink */
            --accent-rose: #f43f5e;
        }

        /* Theme: Monochrome */
        [data-theme="mono"] {
            --bg-dark: #000000;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.2);
            --primary: #ffffff;
            --secondary: #808080;
            --accent-rose: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-stack);
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.5s ease;
        }

        /* Ambient Background */
        .ambient-light {
            position: fixed;
            border-radius: 50%;
            filter: blur(100px);
            z-index: -1;
            opacity: 0.3;
            animation: pulse 10s infinite alternate;
            transition: background 0.5s ease;
        }
        .light-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: var(--primary); }
        .light-2 { bottom: -10%; right: -10%; width: 50vw; height: 50vw; background: var(--secondary); animation-delay: 2s; }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.2; }
            100% { transform: scale(1.1); opacity: 0.3; }
        }

        /* Main App Container - UPDATED FOR LARGE SCREEN */
        .app-container {
            width: 95vw;
            height: 92vh;
            max-width: 1600px; /* Cap width for ultra-wide monitors */
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 40px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            position: relative;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .app-container.fullscreen {
            width: 100vw;
            height: 100vh;
            max-width: none;
            border-radius: 0;
            border: none;
        }

        /* Header */
        .app-header {
            padding: 24px 40px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .header-controls { display: flex; gap: 16px; }
        .window-controls { display: flex; gap: 10px; align-items: center;}
        .control-dot { width: 14px; height: 14px; border-radius: 50%; opacity: 0.8; }
        .title { font-size: 14px; text-transform: uppercase; letter-spacing: 4px; color: var(--text-muted); font-weight: 700; }

        /* Menus */
        .popover-menu {
            position: absolute; top: 70px; right: 30px;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); padding: 16px;
            border-radius: 16px; display: flex; gap: 8px; flex-direction: column;
            z-index: 100; transform: scale(0.9); opacity: 0; pointer-events: none;
            transition: 0.2s ease; min-width: 200px;
        }
        .popover-menu.active { transform: scale(1); opacity: 1; pointer-events: all; }
        .menu-option {
            display: flex; align-items: center; gap: 12px; padding: 12px;
            border-radius: 10px; cursor: pointer; color: white; font-size: 1rem;
        }
        .menu-option:hover { background: rgba(255,255,255,0.1); }
        .menu-option.selected { background: rgba(255,255,255,0.15); color: var(--primary); font-weight: bold; }
        .color-preview { width: 20px; height: 20px; border-radius: 50%; }

        /* Content Area */
        .content-area { flex: 1; position: relative; overflow: hidden; }
        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 40px;
            display: flex; flex-direction: column; align-items: center;
            opacity: 0; pointer-events: none; transform: translateY(20px);
            transition: opacity 0.4s cubic-bezier(0.2, 0, 0, 1), transform 0.4s cubic-bezier(0.2, 0, 0, 1);
        }
        .view.active { opacity: 1; pointer-events: all; transform: translateY(0); }

        /* Navigation - COMPACT DOCK FIX */
        .nav-bar { 
            padding: 20px; 
            background: rgba(0,0,0,0.1); 
            border-top: 1px solid var(--glass-border); 
            display: flex;
            justify-content: center; /* Center the dock */
            flex-shrink: 0;
        }
        .nav-inner { 
            display: flex; 
            justify-content: space-between; 
            background: rgba(255,255,255,0.05); 
            border-radius: 24px; 
            padding: 6px; 
            border: 1px solid var(--glass-border); 
            gap: 4px; 
            width: 100%;
            max-width: 600px; /* Constrain width so it looks like a dock */
        }
        .nav-btn { 
            flex: 1; background: none; border: none; padding: 12px; 
            color: var(--text-muted); border-radius: 18px; cursor: pointer; 
            transition: 0.3s; display: flex; flex-direction: column; align-items: center; 
            gap: 6px; min-width: 60px;
        }
        .nav-btn.active { background: rgba(255,255,255,0.1); color: var(--text-main); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .nav-btn svg { width: 24px; height: 24px; stroke-width: 2; }
        .nav-label { font-size: 11px; font-weight: 600; }

        /* Elements - SCALED UP FONTS */
        .h1-large {
            font-size: 10rem; /* Huge numbers */
            font-weight: 800; letter-spacing: -6px;
            background: linear-gradient(to bottom right, var(--text-main), var(--text-muted));
            -webkit-background-clip: text; background-clip: text; color: transparent;
            margin: 2rem 0; font-variant-numeric: tabular-nums;
            text-shadow: 0 10px 40px rgba(0,0,0,0.2);
            line-height: 1;
        }
        
        /* Responsive font scaling for very wide screens */
        @media (min-width: 1200px) {
            .h1-large { font-size: 14rem; }
        }

        .btn-circle { width: 80px; height: 80px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: white; font-size: 1.5rem; }
        .btn-circle:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); color: var(--bg-dark); box-shadow: 0 0 30px var(--primary); opacity: 0.9; }
        .btn-primary:hover { opacity: 1; transform: scale(1.05); }
        
        .btn-neutral { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.1); color: white;}
        .btn-icon { background: none; border: none; color: var(--text-muted); cursor: pointer; transition: color 0.2s; padding: 8px; }
        .btn-icon svg { width: 24px; height: 24px; }
        .btn-icon:hover { color: var(--text-main); }

        .controls-row { display: flex; gap: 32px; margin-top: 40px; }

        /* Specific Views */
        .date-display { font-size: 2rem; color: var(--text-muted); font-weight: 300; margin-top: 16px; letter-spacing: 2px; }
        
        /* Stopwatch */
        .lap-list { width: 100%; max-width: 600px; flex: 1; overflow-y: auto; margin-top: 40px; padding-right: 8px; }
        .lap-item { display: flex; justify-content: space-between; padding: 16px 24px; background: rgba(255,255,255,0.03); margin-bottom: 10px; border-radius: 16px; border: 1px solid var(--glass-border); font-family: monospace; font-size: 1.2rem; }

        /* Timer */
        .timer-circle-container { position: relative; width: 400px; height: 400px; margin-top: 40px; } /* Larger Circle */
        .timer-svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .timer-circle-bg { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 12; }
        .timer-circle-progress { fill: none; stroke: var(--primary); stroke-width: 12; stroke-linecap: round; stroke-dasharray: 1256; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear; filter: drop-shadow(0 0 15px var(--primary)); }
        .timer-text-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .timer-input-group { display: flex; align-items: center; gap: 16px; margin-bottom: 48px; }
        .timer-input { width: 100px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 16px; padding: 16px; color: var(--text-main); font-size: 2.5rem; text-align: center; outline: none; }
        .timer-label { font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; margin-top: 8px; text-align: center;}
        
        .template-list { display: flex; gap: 12px; margin-bottom: 40px; flex-wrap: wrap; justify-content: center; }
        .template-chip { background: rgba(255,255,255,0.08); border: 1px solid var(--glass-border); padding: 12px 24px; border-radius: 30px; color: var(--text-muted); font-size: 1rem; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .template-chip:hover { background: var(--primary); color: var(--bg-dark); border-color: var(--primary); transform: translateY(-2px); }

        /* Alarm */
        .alarm-form { width: 100%; max-width: 600px; background: rgba(255,255,255,0.05); padding: 24px; border-radius: 24px; display: flex; align-items: center; gap: 20px; margin-bottom: 32px; }
        .time-input { flex: 1; background: transparent; border: none; color: var(--text-main); font-size: 2.5rem; font-family: monospace; outline: none; color-scheme: dark; }
        .alarm-list { width: 100%; max-width: 600px; flex: 1; overflow-y: auto; }
        .alarm-item { display: flex; justify-content: space-between; align-items: center; padding: 24px; background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 20px; margin-bottom: 16px; }
        .alarm-time { font-size: 2.5rem; font-family: monospace; font-weight: 500; }
        .toggle-switch { width: 60px; height: 32px; background: rgba(255,255,255,0.2); border-radius: 16px; position: relative; cursor: pointer; transition: 0.3s; }
        .toggle-switch.on { background: var(--primary); }
        .toggle-knob { width: 26px; height: 26px; background: white; border-radius: 50%; position: absolute; top: 3px; left: 3px; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .toggle-switch.on .toggle-knob { transform: translateX(28px); }

        /* Calendar & ToDo - UPDATED SPLIT LAYOUT */
        .calendar-container { 
            width: 100%; 
            height: 100%;
            display: flex;
            gap: 40px;
        }
        
        .calendar-side { flex: 1; display: flex; flex-direction: column; }
        .todo-side { flex: 1; display: flex; flex-direction: column; background: rgba(0,0,0,0.2); border-radius: 24px; padding: 24px; border: 1px solid var(--glass-border); }

        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; font-weight: bold; font-size: 1.5rem; color: var(--primary); }
        .cal-nav { background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: var(--text-main); cursor: pointer; padding: 8px 16px; border-radius: 12px; font-size: 1.2rem; }
        .cal-nav:hover { background: rgba(255,255,255,0.2); }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; flex: 1; }
        .cal-day-label { font-size: 1rem; color: var(--text-muted); padding-bottom: 8px; font-weight: 700; text-align: center; }
        
        .cal-day {
            aspect-ratio: auto;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 10px;
            border-radius: 16px; cursor: pointer; font-size: 1.2rem; position: relative;
            transition: all 0.2s; color: var(--text-muted); background: rgba(255,255,255,0.02);
        }
        .cal-day:hover:not(.empty) { background: rgba(255,255,255,0.08); color: var(--text-main); transform: scale(1.02); }
        .cal-day.today { border: 2px solid var(--primary); color: var(--primary); font-weight: bold; }
        .cal-day.selected { background: var(--primary); color: var(--bg-dark); font-weight: bold; box-shadow: 0 0 20px var(--primary); }
        .cal-day.has-task::after { content: ''; width: 8px; height: 8px; background: var(--accent-rose); border-radius: 50%; position: absolute; bottom: 8px; }
        .cal-day.selected.has-task::after { background: var(--bg-dark); }
        
        .todo-header { font-size: 1.2rem; color: var(--text-main); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; font-weight: 600; }
        
        .todo-input-form { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; background: rgba(255,255,255,0.05); padding: 16px; border-radius: 16px; border: 1px solid var(--glass-border); flex-shrink: 0; }
        .todo-row { display: flex; gap: 12px; }
        .todo-input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 10px; padding: 12px; color: var(--text-main); outline: none; font-size: 1rem; }
        .todo-add-btn { background: var(--primary); color: var(--bg-dark); border: none; border-radius: 10px; width: 50px; cursor: pointer; font-weight: bold; font-size: 1.5rem; display: flex; align-items: center; justify-content: center;}
        
        .todo-options-row { display: flex; gap: 12px; }
        .todo-time-input, .todo-notify-select { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 10px; padding: 10px; color: var(--text-main); outline: none; font-size: 0.9rem; color-scheme: dark; }
        .todo-notify-select option { background: #1a1a1a; }

        .todo-list { flex: 1; overflow-y: auto; padding-right: 8px; }
        .todo-item { display: flex; align-items: center; gap: 16px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 8px; animation: fadeIn 0.3s ease; position: relative; border: 1px solid transparent; }
        .todo-item:hover { border-color: var(--glass-border); background: rgba(255,255,255,0.08); }
        .todo-checkbox { width: 24px; height: 24px; border: 2px solid var(--text-muted); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0; }
        .todo-item.done .todo-checkbox { background: var(--primary); border-color: var(--primary); }
        .todo-item.done .todo-text { text-decoration: line-through; color: var(--text-muted); }
        .todo-text { font-size: 1rem; }
        .todo-meta { font-size: 0.8rem; }
        
        /* Global Tasks View */
        .tasks-group-header { font-size: 1rem; color: var(--primary); margin-top: 24px; margin-bottom: 12px; font-weight: 800; letter-spacing: 1px; }
        .global-add-task { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 20px; border-radius: 20px; margin-bottom: 20px; }

        .test-notify-btn { background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: var(--text-muted); padding: 12px; border-radius: 12px; font-size: 0.9rem; cursor: pointer; width: 100%; margin-top: 20px; }
        .test-notify-btn:hover { background: rgba(255,255,255,0.15); color: white; }

        /* Ringing Overlay */
        .ringing-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s ease; }
        .ringing-overlay.active { opacity: 1; pointer-events: all; }
        .ringing-title { font-size: 4rem; font-weight: bold; margin-bottom: 16px; color: var(--primary); text-align: center; }
        .ringing-msg { font-size: 1.5rem; color: white; margin-bottom: 60px; text-align: center; max-width: 80%; }
        .ringing-btn { padding: 20px 60px; border-radius: 60px; font-size: 1.5rem; font-weight: bold; cursor: pointer; border: none; background: var(--accent-rose); color: white; box-shadow: 0 0 50px rgba(244, 63, 94, 0.6); animation: pulse-ring 2s infinite; }
        
        @keyframes pulse-ring { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body data-theme="nebula">

    <div class="ambient-light light-1"></div>
    <div class="ambient-light light-2"></div>

    <div class="ringing-overlay" id="ringing-overlay">
        <div class="ringing-title" id="ring-title">Time's Up!</div>
        <div class="ringing-msg" id="ring-msg">Your timer has finished.</div>
        <button class="ringing-btn" onclick="stopRinging()">STOP SOUND</button>
    </div>

    <div class="app-container" id="app-container">
        <!-- Header -->
        <div class="app-header">
            <div class="window-controls">
                <div class="control-dot" style="background: #f43f5e"></div>
                <div class="control-dot" style="background: #fbbf24"></div>
                <div class="control-dot" style="background: #10b981"></div>
            </div>
            <div class="title">Kairos Clock</div>
            <div class="header-controls">
                <button class="btn-icon" id="btn-sound" title="Change Sound">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18V5l12-2v13"></path>
                        <circle cx="6" cy="18" r="3"></circle>
                        <circle cx="18" cy="16" r="3"></circle>
                    </svg>
                </button>
                <button class="btn-icon" id="btn-theme" title="Change Theme">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0"></path>
                    </svg>
                </button>
                <button class="btn-icon" id="btn-fullscreen" title="Toggle Fullscreen">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
                    </svg>
                </button>
            </div>
            
            <!-- Sound Dropdown -->
            <div class="popover-menu" id="sound-menu" style="right: 70px;">
                <div class="menu-option" data-val="cosmic" onclick="selectSound('cosmic')">Cosmic (Default)</div>
                <div class="menu-option" data-val="classic" onclick="selectSound('classic')">Classic</div>
                <div class="menu-option" data-val="zen" onclick="selectSound('zen')">Zen</div>
                <div class="menu-option" data-val="retro" onclick="selectSound('retro')">Retro</div>
                <div class="menu-option" data-val="radar" onclick="selectSound('radar')">Radar</div>
            </div>

            <!-- Theme Dropdown -->
            <div class="popover-menu" id="theme-menu">
                <div class="menu-option" onclick="setTheme('nebula')">
                    <div class="color-preview" style="background: #6366f1"></div> Nebula
                </div>
                <div class="menu-option" onclick="setTheme('cyberpunk')">
                    <div class="color-preview" style="background: #fcee0a"></div> Cyberpunk
                </div>
                <div class="menu-option" onclick="setTheme('forest')">
                    <div class="color-preview" style="background: #10b981"></div> Forest
                </div>
                <div class="menu-option" onclick="setTheme('sunset')">
                    <div class="color-preview" style="background: #f97316"></div> Sunset
                </div>
                <div class="menu-option" onclick="setTheme('mono')">
                    <div class="color-preview" style="background: #ffffff"></div> Monochrome
                </div>
            </div>
        </div>

        <!-- Content Views -->
        <div class="content-area">
            
            <!-- Clock View -->
            <div id="view-clock" class="view active">
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <div style="color: var(--primary); letter-spacing: 4px; font-size: 1.2rem; margin-bottom: 1.5rem; text-transform: uppercase; font-weight: 600;">Local Time</div>
                    <div id="clock-display" class="h1-large">00:00:00</div>
                    <div id="date-display" class="date-display">Monday, January 1</div>
                </div>
            </div>

            <!-- Timer View -->
            <div id="view-timer" class="view">
                <div id="timer-setup" style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%;">
                    
                    <div class="template-list">
                        <button class="template-chip" data-h="0" data-m="0" data-s="10">10s</button>
                        <button class="template-chip" data-h="0" data-m="10" data-s="0">10m</button>
                        <button class="template-chip" data-h="0" data-m="25" data-s="0" onclick="setPomodoroMode(true)">Pomodoro (25m)</button>
                        <button class="template-chip" data-h="0" data-m="10" data-s="0">Break (10m)</button>
                        <button class="template-chip" data-h="1" data-m="0" data-s="0">1hr</button>
                    </div>

                    <div class="timer-input-group">
                        <div>
                            <input type="number" id="t-hr" class="timer-input" value="00" min="0" max="99">
                            <div class="timer-label">HR</div>
                        </div>
                        <div style="font-size: 4rem; font-weight: bold; margin-bottom: 30px; color: var(--text-muted)">:</div>
                        <div>
                            <input type="number" id="t-min" class="timer-input" value="25" min="0" max="59">
                            <div class="timer-label">MIN</div>
                        </div>
                        <div style="font-size: 4rem; font-weight: bold; margin-bottom: 30px; color: var(--text-muted)">:</div>
                        <div>
                            <input type="number" id="t-sec" class="timer-input" value="00" min="0" max="59">
                            <div class="timer-label">SEC</div>
                        </div>
                    </div>
                    <button class="btn-circle btn-primary" id="btn-start-timer" style="width: 100px; height: 100px; font-size: 2rem;">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                </div>

                <!-- Running State -->
                <div id="timer-running" class="hidden" style="flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                    <div class="timer-circle-container">
                        <svg class="timer-svg" viewBox="0 0 300 300">
                            <circle class="timer-circle-bg" cx="150" cy="150" r="140"></circle>
                            <circle id="timer-progress" class="timer-circle-progress" cx="150" cy="150" r="140"></circle>
                        </svg>
                        <div class="timer-text-overlay">
                            <div id="timer-display" class="h1-large" style="font-size: 6rem; margin:0;">00:00:00</div>
                            <div style="color: var(--text-muted); font-size: 1.2rem; letter-spacing: 4px; margin-top: 10px;">REMAINING</div>
                        </div>
                    </div>

                    <div class="controls-row">
                        <button class="btn-circle btn-primary" id="btn-pause-timer">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                        </button>
                        <button class="btn-circle btn-neutral" id="btn-reset-timer">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stopwatch View -->
            <div id="view-stopwatch" class="view">
                <div style="margin-top: 60px;">
                    <div id="sw-display" class="h1-large">00:00<span style="font-size: 4rem; color: var(--accent-rose); vertical-align: middle; margin-left: 10px;">.00</span></div>
                </div>

                <div class="controls-row">
                    <button class="btn-circle btn-primary" id="btn-sw-start" style="background: var(--primary);">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                    <button class="btn-circle btn-neutral hidden" id="btn-sw-lap">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                    <button class="btn-circle btn-primary hidden" id="btn-sw-pause" style="background: var(--accent-rose);">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </button>
                    <button class="btn-circle btn-neutral" id="btn-sw-reset">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                    </button>
                </div>

                <div id="lap-list" class="lap-list custom-scrollbar">
                    <!-- Laps go here -->
                </div>
            </div>

            <!-- Alarm View -->
            <div id="view-alarm" class="view">
                <form id="alarm-form" class="alarm-form">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    <input type="time" id="alarm-input" class="time-input" required>
                    <button type="submit" class="btn-circle btn-primary" style="width: 60px; height: 60px;">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </form>

                <div id="alarm-list" class="alarm-list custom-scrollbar">
                    <!-- Alarms go here -->
                    <div style="text-align: center; color: var(--text-muted); margin-top: 60px; font-size: 1.2rem;">No alarms set</div>
                </div>
                
                <button class="test-notify-btn" onclick="startRinging('Test Alert', 'This is how the alarm sounds!', false)" style="max-width: 600px;">
                    Test Sound & Alert
                </button>
            </div>

            <!-- Calendar View (Split Layout) -->
            <div id="view-calendar" class="view">
                <div class="calendar-container">
                    <!-- Calendar Side -->
                    <div class="calendar-side">
                        <div class="calendar-header">
                            <button class="cal-nav" id="prev-month">&lt;</button>
                            <span id="cal-month-year">January 2024</span>
                            <button class="cal-nav" id="next-month">&gt;</button>
                        </div>
                        
                        <div class="calendar-grid">
                            <div class="cal-day-label">Su</div><div class="cal-day-label">Mo</div><div class="cal-day-label">Tu</div>
                            <div class="cal-day-label">We</div><div class="cal-day-label">Th</div><div class="cal-day-label">Fr</div>
                            <div class="cal-day-label">Sa</div>
                            <!-- Calendar Days Generated Here -->
                            <div id="cal-grid-content" style="display: contents;"></div>
                        </div>
                    </div>
                    
                    <!-- Todo Side -->
                    <div class="todo-side">
                        <div class="todo-header">
                            <span id="todo-date-title">Tasks</span>
                            <span id="todo-count" style="font-size:0.9rem; background:rgba(255,255,255,0.1); padding:4px 10px; border-radius:12px;">0</span>
                        </div>
                        <form id="todo-form" class="todo-input-form">
                            <div class="todo-row">
                                <input type="text" id="todo-input" class="todo-input" placeholder="Add task..." required>
                                <button type="submit" class="todo-add-btn">+</button>
                            </div>
                            <div class="todo-options-row">
                                <input type="time" id="todo-time" class="todo-time-input">
                                <select id="todo-notify" class="todo-notify-select">
                                    <option value="none">No Alert</option>
                                    <option value="0">At time</option>
                                    <option value="10">10m before</option>
                                    <option value="20">20m before</option>
                                    <option value="30">30m before</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </form>
                        <div id="todo-list" class="todo-list custom-scrollbar"></div>
                    </div>
                </div>
            </div>

            <!-- Global Tasks View -->
             <div id="view-tasks" class="view">
                <div style="width: 100%; max-width: 800px; display: flex; flex-direction: column; height: 100%;">
                    <div class="todo-header" style="font-size: 1.5rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 16px; margin-bottom: 0;">
                        <span>All Tasks</span>
                    </div>
                    
                    <div class="global-add-task" style="margin-top: 16px;">
                         <form id="global-todo-form" class="todo-input-form" style="margin-bottom:0; background: transparent; border:none; padding:0;">
                            <div class="todo-row">
                                <input type="text" id="global-todo-input" class="todo-input" placeholder="Task name..." required>
                                <button type="submit" class="todo-add-btn">+</button>
                            </div>
                            <div class="todo-options-row">
                                <input type="date" id="global-todo-date" class="todo-time-input" required>
                                <input type="time" id="global-todo-time" class="todo-time-input">
                                <select id="global-todo-notify" class="todo-notify-select">
                                    <option value="none">No Alert</option>
                                    <option value="0">At time</option>
                                    <option value="10">10m before</option>
                                    <option value="20">20m before</option>
                                    <option value="30">30m before</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </form>
                    </div>

                    <div id="global-todo-list" class="todo-list custom-scrollbar" style="margin-top: 16px;">
                        <!-- Tasks will be injected here -->
                    </div>
                </div>
             </div>

        </div>

        <!-- Navigation Bar -->
        <div class="nav-bar">
            <div class="nav-inner">
                <button class="nav-btn active" data-target="clock">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    <span class="nav-label">Clock</span>
                </button>
                <button class="nav-btn" data-target="timer">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M5 22h14"/><path d="M5 2h14"/><path d="M17 22v-4.172a2 2 0 0 0-.586-1.414L12 12l-4.414 4.414A2 2 0 0 0 7 17.828V22"/><path d="M7 2v4.172a2 2 0 0 0 .586 1.414L12 12l4.414-4.414A2 2 0 0 0 17 6.172V2"/></svg>
                    <span class="nav-label">Timer</span>
                </button>
                <button class="nav-btn" data-target="stopwatch">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/><path d="M22 2l-3 3"/><path d="M2 2l3 3"/></svg>
                    <span class="nav-label">Watch</span>
                </button>
                <button class="nav-btn" data-target="alarm">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                    <span class="nav-label">Alarm</span>
                </button>
                <button class="nav-btn" data-target="calendar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="nav-label">Calendar</span>
                </button>
                <button class="nav-btn" data-target="tasks">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                    <span class="nav-label">Tasks</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Sound Engine ---
        let currentSound = localStorage.getItem('chronos_sound') || 'cosmic';
        
        const soundPatterns = {
            'cosmic': (ctx, t) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(880, t);
                osc.frequency.exponentialRampToValueAtTime(440, t + 0.5);
                gain.gain.setValueAtTime(0.5, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.5);
                osc.start(t);
                osc.stop(t + 0.5);
            },
            'classic': (ctx, t) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'square';
                osc.frequency.setValueAtTime(1000, t);
                gain.gain.setValueAtTime(0.3, t);
                gain.gain.setValueAtTime(0, t + 0.1);
                gain.gain.setValueAtTime(0.3, t + 0.2);
                gain.gain.setValueAtTime(0, t + 0.3);
                osc.start(t);
                osc.stop(t + 0.4);
            },
            'zen': (ctx, t) => {
                // Harmonic Chime
                [523.25, 659.25, 783.99].forEach(freq => { // C major
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(freq, t);
                    gain.gain.setValueAtTime(0.1, t);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 2);
                    osc.start(t);
                    osc.stop(t + 2);
                });
            },
            'retro': (ctx, t) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(220, t);
                osc.frequency.linearRampToValueAtTime(440, t + 0.1);
                osc.frequency.linearRampToValueAtTime(880, t + 0.2);
                gain.gain.setValueAtTime(0.2, t);
                gain.gain.linearRampToValueAtTime(0, t + 0.3);
                osc.start(t);
                osc.stop(t + 0.3);
            },
            'radar': (ctx, t) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1500, t);
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.5, t + 0.05);
                gain.gain.linearRampToValueAtTime(0, t + 0.5);
                osc.start(t);
                osc.stop(t + 0.6);
            }
        };

        // --- System: Audio & Notifications ---
        let alarmInterval = null;
        let audioContext = null;
        let isPomodoroSequence = false;

        const startRinging = (title, body, isPomodoro = false) => {
            // Visual Overlay
            const overlay = document.getElementById('ringing-overlay');
            document.getElementById('ring-title').textContent = title;
            document.getElementById('ring-msg').textContent = body;
            overlay.classList.add('active');
            
            isPomodoroSequence = isPomodoro;

            // System Notification
            if ("Notification" in window) {
                if (Notification.permission === "granted") {
                    new Notification(title, { body });
                } else if (Notification.permission !== "denied") {
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") new Notification(title, { body });
                    });
                }
            }

            // Continuous Audio
            if (alarmInterval) return; 
            
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            const playLoop = () => {
                if(audioContext.state === 'suspended') audioContext.resume();
                // Use selected sound pattern
                const pattern = soundPatterns[currentSound] || soundPatterns['cosmic'];
                pattern(audioContext, audioContext.currentTime);
            };
            
            playLoop(); 
            // adjust interval mostly for 'cosmic' style, others fit within 800ms-2s easily
            // Zen overlaps nicely, digital repeats fast enough
            alarmInterval = setInterval(playLoop, currentSound === 'zen' ? 2000 : 1000); 
        };

        window.stopRinging = () => {
            if (alarmInterval) {
                clearInterval(alarmInterval);
                alarmInterval = null;
            }
            document.getElementById('ringing-overlay').classList.remove('active');
            
            // Handle Pomodoro Sequence
            if (isPomodoroSequence) {
                isPomodoroSequence = false;
                if(confirm("Pomodoro Finished! Start 10 min break now?")) {
                    // Set break
                    document.getElementById('t-hr').value = 0;
                    document.getElementById('t-min').value = 10;
                    document.getElementById('t-sec').value = 0;
                    document.getElementById('btn-start-timer').click();
                }
            }
        };

        const checkNotificationPermission = () => {
            if ("Notification" in window && Notification.permission === "default") {
                Notification.requestPermission();
            }
        };

        // --- Menus (Theme & Sound) ---
        const btnTheme = document.getElementById('btn-theme');
        const themeMenu = document.getElementById('theme-menu');
        const btnSound = document.getElementById('btn-sound');
        const soundMenu = document.getElementById('sound-menu');
        
        btnTheme.addEventListener('click', (e) => { e.stopPropagation(); themeMenu.classList.toggle('active'); soundMenu.classList.remove('active'); });
        btnSound.addEventListener('click', (e) => { e.stopPropagation(); soundMenu.classList.toggle('active'); themeMenu.classList.remove('active'); });

        document.addEventListener('click', (e) => {
            if (!themeMenu.contains(e.target) && e.target !== btnTheme) themeMenu.classList.remove('active');
            if (!soundMenu.contains(e.target) && e.target !== btnSound) soundMenu.classList.remove('active');
        });

        window.setTheme = (themeName) => {
            document.body.setAttribute('data-theme', themeName);
            localStorage.setItem('chronos_theme', themeName);
            themeMenu.classList.remove('active');
        };

        window.selectSound = (soundName) => {
            currentSound = soundName;
            localStorage.setItem('chronos_sound', soundName);
            // Highlight selected
            document.querySelectorAll('#sound-menu .menu-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.val === soundName);
            });
            // Preview
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if(audioContext.state === 'suspended') audioContext.resume();
            soundPatterns[soundName](audioContext, audioContext.currentTime);
        };

        // Init Theme & Sound UI
        const savedTheme = localStorage.getItem('chronos_theme') || 'nebula';
        setTheme(savedTheme);
        document.querySelectorAll('#sound-menu .menu-option').forEach(el => {
            el.classList.toggle('selected', el.dataset.val === currentSound);
        });

        // --- Navigation ---
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`view-${btn.dataset.target}`).classList.add('active');
                localStorage.setItem('chronos_active_tab', btn.dataset.target);
                
                if(btn.dataset.target === 'tasks') {
                    document.getElementById('global-todo-date').value = getYYYYMMDD(new Date());
                    renderGlobalTodos();
                }
            });
        });
        const savedTab = localStorage.getItem('chronos_active_tab') || 'clock';
        const initialBtn = document.querySelector(`.nav-btn[data-target="${savedTab}"]`);
        if(initialBtn) initialBtn.click();
        
        // --- Fullscreen ---
        const btnFullscreen = document.getElementById('btn-fullscreen');
        const appContainer = document.getElementById('app-container');
        btnFullscreen.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
                else if (document.documentElement.webkitRequestFullscreen) document.documentElement.webkitRequestFullscreen();
                appContainer.classList.add('fullscreen');
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                appContainer.classList.remove('fullscreen');
            }
        });
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) appContainer.classList.remove('fullscreen');
        });

        // --- Clock ---
        const updateClock = () => {
            const now = new Date();
            document.getElementById('clock-display').textContent = now.toLocaleTimeString('en-US', { hour12: false });
            document.getElementById('date-display').textContent = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        };
        setInterval(updateClock, 1000);
        updateClock();

        // --- Stopwatch ---
        let swStartTime=0, swElapsedTime=0, swInterval;
        const swDisplay = document.getElementById('sw-display');
        const lapList = document.getElementById('lap-list');
        const formatSw = (ms) => {
            const m = Math.floor(ms/60000).toString().padStart(2,'0');
            const s = Math.floor((ms%60000)/1000).toString().padStart(2,'0');
            const cs = Math.floor((ms%1000)/10).toString().padStart(2,'0');
            return `${m}:${s}<span style="font-size: 2rem; opacity: 0.7; vertical-align: middle; margin-left: 5px;">.${cs}</span>`;
        };
        const updateStopwatch = () => swDisplay.innerHTML = formatSw(Date.now() - swStartTime + swElapsedTime);
        
        document.getElementById('btn-sw-start').addEventListener('click', function() {
            swStartTime = Date.now(); swInterval = setInterval(updateStopwatch, 10);
            this.classList.add('hidden'); document.getElementById('btn-sw-pause').classList.remove('hidden');
            document.getElementById('btn-sw-lap').classList.remove('hidden'); document.getElementById('btn-sw-reset').classList.add('hidden');
        });
        document.getElementById('btn-sw-pause').addEventListener('click', function() {
            clearInterval(swInterval); swElapsedTime += Date.now() - swStartTime;
            this.classList.add('hidden'); document.getElementById('btn-sw-start').classList.remove('hidden');
            document.getElementById('btn-sw-lap').classList.add('hidden'); document.getElementById('btn-sw-reset').classList.remove('hidden');
        });
        document.getElementById('btn-sw-reset').addEventListener('click', () => {
            clearInterval(swInterval); swElapsedTime = 0; swDisplay.innerHTML = formatSw(0); lapList.innerHTML = '';
            document.getElementById('btn-sw-start').classList.remove('hidden'); document.getElementById('btn-sw-pause').classList.add('hidden');
        });
        document.getElementById('btn-sw-lap').addEventListener('click', () => {
            const div = document.createElement('div'); div.className = 'lap-item';
            div.innerHTML = `<span>Lap ${lapList.children.length + 1}</span><span>${formatSw(Date.now() - swStartTime + swElapsedTime).replace(/<[^>]*>/g, '.')}</span>`;
            lapList.prepend(div);
        });

        // --- Timer ---
        let timerInterval, totalTime=0, timeLeft=0;
        let isPomodoro = false;
        const CIRCUMFERENCE = 2 * Math.PI * 140;
        document.getElementById('timer-progress').style.strokeDasharray = CIRCUMFERENCE;
        
        window.setPomodoroMode = (enable) => { isPomodoro = enable; }

        document.querySelectorAll('.template-chip').forEach(chip => chip.addEventListener('click', () => {
            // Reset pomodoro unless explicitly set by button
            if(!chip.onclick) isPomodoro = false;
            document.getElementById('t-hr').value = chip.dataset.h.padStart(2,'0');
            document.getElementById('t-min').value = chip.dataset.m.padStart(2,'0');
            document.getElementById('t-sec').value = chip.dataset.s.padStart(2,'0');
        }));

        const updateTimerVisuals = () => {
            const h = Math.floor(timeLeft/3600).toString().padStart(2,'0');
            const m = Math.floor((timeLeft%3600)/60).toString().padStart(2,'0');
            const s = (timeLeft%60).toString().padStart(2,'0');
            document.getElementById('timer-display').textContent = `${h}:${m}:${s}`;
            document.getElementById('timer-progress').style.strokeDashoffset = CIRCUMFERENCE - (timeLeft/totalTime)*CIRCUMFERENCE;
        };

        document.getElementById('btn-start-timer').addEventListener('click', () => {
            checkNotificationPermission();
            totalTime = (parseInt(document.getElementById('t-hr').value)||0)*3600 + (parseInt(document.getElementById('t-min').value)||0)*60 + (parseInt(document.getElementById('t-sec').value)||0);
            if(totalTime<=0) return;
            timeLeft = totalTime;
            document.getElementById('timer-setup').classList.add('hidden');
            document.getElementById('timer-running').classList.remove('hidden'); document.getElementById('timer-running').style.display='flex';
            updateTimerVisuals();
            timerInterval = setInterval(() => { 
                timeLeft--; 
                updateTimerVisuals(); 
                if(timeLeft<=0) { 
                    clearInterval(timerInterval); 
                    const title = isPomodoro ? "Pomodoro Complete!" : "Timer Finished";
                    const msg = isPomodoro ? "Time for a break." : "Your count down is complete.";
                    startRinging(title, msg, isPomodoro); 
                    resetTimerUI(); 
                } 
            }, 1000);
        });

        document.getElementById('btn-pause-timer').addEventListener('click', function() {
            if(timerInterval) { clearInterval(timerInterval); timerInterval=null; this.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>`; }
            else { timerInterval = setInterval(() => { timeLeft--; updateTimerVisuals(); if(timeLeft<=0) { clearInterval(timerInterval); startRinging("Timer Finished", "Your countdown is complete."); resetTimerUI(); } }, 1000); this.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`; }
        });

        const resetTimerUI = () => {
            clearInterval(timerInterval); timerInterval=null;
            document.getElementById('timer-setup').classList.remove('hidden');
            document.getElementById('timer-running').classList.add('hidden'); document.getElementById('timer-running').style.display='none';
            document.getElementById('btn-pause-timer').innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`;
        };
        document.getElementById('btn-reset-timer').addEventListener('click', resetTimerUI);

        // --- Alarm ---
        let alarms = JSON.parse(localStorage.getItem('chronos_alarms')) || [];
        const renderAlarms = () => {
            const list = document.getElementById('alarm-list');
            if(alarms.length===0) { list.innerHTML = '<div style="text-align: center; color: var(--text-muted); margin-top: 40px;">No alarms set</div>'; return; }
            list.innerHTML = '';
            alarms.forEach(a => {
                list.innerHTML += `<div class="alarm-item">
                    <div class="alarm-time" style="color: ${a.enabled ? 'var(--text-main)' : 'var(--text-muted)'}">${a.time}</div>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="toggle-switch ${a.enabled ? 'on' : ''}" onclick="toggleAlarm(${a.id})"><div class="toggle-knob"></div></div>
                        <div style="cursor: pointer; color: var(--text-muted)" onclick="deleteAlarm(${a.id})">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </div>
                    </div>
                </div>`;
            });
        };
        window.toggleAlarm = (id) => { alarms = alarms.map(a => a.id===id ? {...a, enabled: !a.enabled, triggered: false} : a); saveAlarms(); };
        window.deleteAlarm = (id) => { alarms = alarms.filter(a => a.id!==id); saveAlarms(); };
        const saveAlarms = () => { localStorage.setItem('chronos_alarms', JSON.stringify(alarms)); renderAlarms(); };
        
        document.getElementById('alarm-form').addEventListener('submit', (e) => {
            e.preventDefault(); 
            checkNotificationPermission();
            const t = document.getElementById('alarm-input').value; if(!t) return;
            alarms.push({ id: Date.now(), time: t, enabled: true, triggered: false }); saveAlarms(); document.getElementById('alarm-input').value = '';
        });

        // --- Task/Alarm Loop ---
        setInterval(() => {
            const now = new Date();
            const currentH = now.getHours();
            const currentM = now.getMinutes();
            const currentS = now.getSeconds();
            const tStr = `${currentH.toString().padStart(2,'0')}:${currentM.toString().padStart(2,'0')}`;

            if(currentS === 0) {
                // Alarms
                alarms.forEach(a => {
                    if(a.enabled && !a.triggered && a.time === tStr) {
                        startRinging("Alarm", `It is ${a.time}`); a.triggered = true; a.enabled = false; saveAlarms();
                    }
                });

                // Tasks
                const todayKey = getYYYYMMDD(now);
                if(todos[todayKey]) {
                    todos[todayKey].forEach(task => {
                        if(task.time && !task.done && !task.notified && task.notifyType !== 'none') {
                            const [th, tm] = task.time.split(':').map(Number);
                            const taskTimeInMin = th * 60 + tm;
                            const currentTimeInMin = currentH * 60 + currentM;
                            const delta = parseInt(task.notifyDelta || 0);
                            
                            if(currentTimeInMin === (taskTimeInMin - delta)) {
                                const msg = delta > 0 ? `Task due in ${delta} mins: ${task.text}` : `Task due now: ${task.text}`;
                                startRinging("Task Reminder", msg);
                                task.notified = true;
                                saveTodos();
                            }
                        }
                    });
                }
            }
        }, 1000);
        
        renderAlarms();

        // --- Calendar & ToDo Logic ---
        const calGrid = document.getElementById('cal-grid-content');
        const calMonthYear = document.getElementById('cal-month-year');
        const todoList = document.getElementById('todo-list');
        const todoDateTitle = document.getElementById('todo-date-title');
        const todoCount = document.getElementById('todo-count');
        const globalTodoList = document.getElementById('global-todo-list');
        
        let calDate = new Date();
        let selectedDate = new Date();
        let todos = JSON.parse(localStorage.getItem('chronos_todos')) || {};

        const getYYYYMMDD = (date) => {
            return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
        };

        const renderCalendar = () => {
            calGrid.innerHTML = '';
            const y = calDate.getFullYear();
            const m = calDate.getMonth();
            
            calMonthYear.textContent = new Date(y, m).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m+1, 0).getDate();
            const todayStr = getYYYYMMDD(new Date());
            const selectedStr = getYYYYMMDD(selectedDate);

            for(let i=0; i<firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'cal-day empty';
                calGrid.appendChild(empty);
            }

            for(let i=1; i<=daysInMonth; i++) {
                const dayEl = document.createElement('div');
                const currentDayStr = `${y}-${(m+1).toString().padStart(2,'0')}-${i.toString().padStart(2,'0')}`;
                dayEl.className = 'cal-day';
                dayEl.textContent = i;
                if(currentDayStr === todayStr) dayEl.classList.add('today');
                if(currentDayStr === selectedStr) dayEl.classList.add('selected');
                if(todos[currentDayStr] && todos[currentDayStr].filter(t=>!t.done).length > 0) dayEl.classList.add('has-task');
                dayEl.onclick = () => { selectedDate = new Date(y, m, i); renderCalendar(); renderTodos(); };
                calGrid.appendChild(dayEl);
            }
        };

        const renderTodos = () => {
            const dateKey = getYYYYMMDD(selectedDate);
            todoDateTitle.textContent = selectedDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            const dayTodos = todos[dateKey] || [];
            todoCount.textContent = dayTodos.filter(t => !t.done).length;
            todoList.innerHTML = '';

            if(dayTodos.length === 0) {
                todoList.innerHTML = '<div style="text-align:center; color:var(--text-muted); margin-top:20px; font-size:0.9rem;">No tasks for this day</div>';
                return;
            }

            dayTodos.sort((a,b) => { if(!a.time) return 1; if(!b.time) return -1; return a.time.localeCompare(b.time); });

            dayTodos.forEach(todo => {
                const item = document.createElement('div');
                item.className = `todo-item ${todo.done ? 'done' : ''}`;
                let timeBadge = '';
                if(todo.time) {
                    const hasAlert = todo.notifyType !== 'none';
                    timeBadge = `<span class="todo-meta" style="color: ${hasAlert ? 'var(--primary)' : 'inherit'}">${todo.time}${hasAlert ? ' ' : ''}</span>`;
                }
                item.innerHTML = `
                    <div class="todo-checkbox" onclick="toggleTodo('${dateKey}', ${todo.id})">
                        ${todo.done ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="4"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                    </div>
                    <div class="todo-content"><span class="todo-text">${todo.text}</span>${timeBadge}</div>
                    <button class="todo-del" onclick="deleteTodo('${dateKey}', ${todo.id})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                `;
                todoList.appendChild(item);
            });
        };

        window.renderGlobalTodos = () => {
            globalTodoList.innerHTML = '';
            const sortedDates = Object.keys(todos).sort();
            let hasTasks = false;
            const now = new Date();
            const todayStr = getYYYYMMDD(now);

            sortedDates.forEach(dateKey => {
                if(dateKey < todayStr && todos[dateKey].every(t => t.done)) return;
                const dayTasks = todos[dateKey];
                if(dayTasks && dayTasks.length > 0) {
                    hasTasks = true;
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'tasks-group-header';
                    const d = new Date(dateKey);
                    const localDate = new Date(d.valueOf() + d.getTimezoneOffset() * 60000);
                    dateHeader.textContent = localDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    globalTodoList.appendChild(dateHeader);

                    dayTasks.sort((a,b) => { if(!a.time) return 1; if(!b.time) return -1; return a.time.localeCompare(b.time); });

                    dayTasks.forEach(todo => {
                        const item = document.createElement('div');
                        item.className = `todo-item ${todo.done ? 'done' : ''}`;
                        let timeBadge = '';
                        if(todo.time) {
                             const hasAlert = todo.notifyType !== 'none';
                            timeBadge = `<span class="todo-meta" style="color: ${hasAlert ? 'var(--primary)' : 'inherit'}">${todo.time}${hasAlert ? ' ' : ''}</span>`;
                        }
                        item.innerHTML = `
                            <div class="todo-checkbox" onclick="toggleTodo('${dateKey}', ${todo.id})">${todo.done ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="4"><polyline points="20 6 9 17 4 12"/></svg>' : ''}</div>
                            <div class="todo-content"><span class="todo-text">${todo.text}</span>${timeBadge}</div>
                            <button class="todo-del" onclick="deleteTodo('${dateKey}', ${todo.id})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                        `;
                        globalTodoList.appendChild(item);
                    });
                }
            });
            if(!hasTasks) globalTodoList.innerHTML = '<div style="text-align:center; color:var(--text-muted); margin-top:40px;">No tasks found.</div>';
        };

        const saveTodos = () => {
            localStorage.setItem('chronos_todos', JSON.stringify(todos));
            renderCalendar(); renderTodos();
            if(document.getElementById('view-tasks').classList.contains('active')) renderGlobalTodos();
        };

        window.toggleTodo = (dateKey, id) => {
            if(todos[dateKey]) { todos[dateKey] = todos[dateKey].map(t => t.id === id ? {...t, done: !t.done} : t); saveTodos(); }
        };

        window.deleteTodo = (dateKey, id) => {
            if(todos[dateKey]) {
                todos[dateKey] = todos[dateKey].filter(t => t.id !== id);
                if(todos[dateKey].length === 0) delete todos[dateKey];
                saveTodos();
            }
        };
        
        const handleAddTodo = (text, time, notifyType, dateKey) => {
             if(!text) return;
            checkNotificationPermission();
            if(!todos[dateKey]) todos[dateKey] = [];
            
            let notifyDelta = 0;
            if(notifyType === 'custom') {
                const customMin = prompt("Enter minutes before task to notify:", "15");
                if(customMin !== null) notifyDelta = parseInt(customMin); else notifyType = 'none';
            } else if (notifyType !== 'none') notifyDelta = parseInt(notifyType);

            todos[dateKey].push({ id: Date.now(), text, done: false, time: time || null, notifyType: notifyType, notifyDelta: notifyDelta, notified: false });
            saveTodos();
        }

        document.getElementById('todo-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('todo-input');
            handleAddTodo(input.value.trim(), document.getElementById('todo-time').value, document.getElementById('todo-notify').value, getYYYYMMDD(selectedDate));
            input.value = ''; document.getElementById('todo-time').value = ''; document.getElementById('todo-notify').value = 'none';
        });

        document.getElementById('global-todo-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('global-todo-input');
            const dateInput = document.getElementById('global-todo-date');
            if(!dateInput.value) { alert("Please select a date"); return; }
            handleAddTodo(input.value.trim(), document.getElementById('global-todo-time').value, document.getElementById('global-todo-notify').value, dateInput.value);
            input.value = ''; document.getElementById('global-todo-time').value = ''; document.getElementById('global-todo-notify').value = 'none';
        });

        document.getElementById('prev-month').onclick = () => { calDate.setMonth(calDate.getMonth() - 1); renderCalendar(); };
        document.getElementById('next-month').onclick = () => { calDate.setMonth(calDate.getMonth() + 1); renderCalendar(); };

        renderCalendar();
        renderTodos();

    </script>
</body>
</html>
